{% extends "base.html" %}
{% block title %}Classificazione • Smart Waste{% endblock %}
{% block content %}

<div class="grid lg:grid-cols-12 gap-6">
  <!-- Upload -->
  <section class="lg:col-span-7 space-y-4">
    <div id="dropzone"
         class="border-2 border-dashed border-gray-700 rounded-xl bg-gray-900/50 hover:bg-gray-900/70 transition p-6 cursor-pointer select-none">
      <div class="flex flex-col items-center justify-center py-8 pointer-events-none">
        <img src="{{ url_for('static', filename='img/upload.svg') }}" alt="" class="w-12 h-12 opacity-70 mb-3"
             onerror="this.replaceWith(document.getElementById('svg-fallback').content.cloneNode(true))">
        <p class="text-gray-300 font-medium">Trascina qui l'immagine</p>
        <p class="text-gray-500 text-sm">oppure clicca per selezionarla (.JPG/.PNG/.WebP, max 10MB)</p>
      </div>
      <input id="fileInput" type="file" accept="image/jpeg,image/png,image/webp" class="hidden">
    </div>

    <label class="inline-flex items-center gap-2 text-sm text-gray-300">
      <input id="consentCheckbox" type="checkbox" class="accent-emerald-600" {% if user_default_consent %}checked{% endif %}>
      <span>Consento l'uso di <span class="underline decoration-dotted">questa</span> immagine per addestrare il modello</span>
    </label>

    <div id="previewWrap" class="hidden bg-gray-900/60 border border-gray-800 rounded-xl p-4">
      <div class="text-emerald-400 text-sm mb-2">Immagine pronta. Clicca sull’anteprima per cambiarla.</div>
      <div class="aspect-video bg-black/20 rounded-lg overflow-hidden flex items-center justify-center">
        <img id="previewImg" alt="Anteprima" class="max-h-[60vh] object-contain cursor-pointer">
      </div>
    </div>

    <div class="flex gap-3">
      <button id="predictBtn" class="px-4 py-2 rounded-lg bg-emerald-700 hover:bg-emerald-600 disabled:opacity-50 disabled:cursor-not-allowed">Predici</button>
      <button id="clearBtn"   class="px-4 py-2 rounded-lg bg-gray-800 hover:bg-gray-700 border border-gray-700">Pulisci</button>
    </div>
  </section>

  <!-- Risultato -->
  <aside class="lg:col-span-5">
    <div class="bg-gray-900/60 border border-gray-800 rounded-xl p-4 lg:sticky lg:top-4">
      <h2 class="text-lg font-semibold mb-3">Risultato</h2>

      <div id="resultEmpty" class="text-gray-400 text-sm">
        Carica un'immagine e premi “Predici”.
      </div>

      <div id="resultCard" class="hidden space-y-3">
        <div class="flex items-center gap-2">
          <span class="text-sm text-gray-400">Classe:</span>
          <span id="resClass" class="px-2 py-1 rounded bg-gray-800 border border-gray-700 text-sm">—</span>
          <span class="ml-auto text-sm text-gray-400">Confidenza:</span>
          <span id="resConf" class="px-2 py-1 rounded bg-gray-800 border border-gray-700 text-sm">—</span>
        </div>

        <div id="actionsRow" class="flex items-center gap-3">
          <button id="btnCorrect" class="flex-1 px-4 py-2 rounded-lg bg-emerald-700 hover:bg-emerald-600">✓ È corretta</button>
          <button id="btnWrong"   class="flex-1 px-4 py-2 rounded-lg bg-rose-700    hover:bg-rose-600">✖ È sbagliata</button>
        </div>

        <div id="correctionRow" class="hidden flex items-center gap-3">
          <select id="correctionSelect" class="flex-1 bg-gray-800 border border-gray-700 rounded-lg px-3 py-2">
            {% for c in class_names %}<option value="{{ c }}">{{ c }}</option>{% endfor %}
          </select>
          <button id="sendCorrection" class="px-4 py-2 rounded-lg bg-rose-700 hover:bg-rose-600">✎ Invia correzione</button>
        </div>

        <div id="resultMsg" class="hidden text-sm"></div>
      </div>
    </div>
  </aside>
</div>

<!-- Fallback per l’icona upload (se l’SVG non si carica) -->
<template id="svg-fallback">
  <svg xmlns="http://www.w3.org/2000/svg" class="w-12 h-12 opacity-70 mb-3" viewBox="0 0 24 24" fill="currentColor">
    <path d="M19 15v4H5v-4H3v4a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-4Zm-7-1 3.5 3.5-1.42 1.42L13 17.83V9h-2v8.83l-1.08 1.09L8.5 17Z"/>
  </svg>
</template>

<!-- Dati per lo script -->
<script type="application/json" id="page-data">
{
  "csrf": "{{ csrf_token() }}",
  "preload": {{ preload|tojson|safe if preload else 'null' }}
}
</script>
<script src="{{ url_for('static', filename='js/index.js') }}" defer></script>
{% endblock %}
