{% extends "base.html" %}
{% block title %}Classifica Â· Smart Waste{% endblock %}

{% block content %}
<div class="max-w-3xl mx-auto grid gap-6">

  <!-- Card Upload -->
  <div class="bg-gray-900/70 border border-gray-800 rounded-2xl p-6 shadow-xl">
    <h2 class="text-xl font-semibold text-emerald-400">Classifica un rifiuto</h2>
    <p class="text-gray-400 mt-1">Carica un'immagine e conferma il risultato per migliorare il modello.</p>

    <form id="uploadForm" method="post" enctype="multipart/form-data" class="mt-6 space-y-4">
      {{ form.hidden_tag() }}

      {% set has_session_pending = preload is not none %}

      <div id="dropZone"
           class="rounded-xl border-2 border-dashed border-emerald-700/60 p-8 text-center transition
                  {% if has_session_pending %}opacity-50 pointer-events-none{% else %}hover:bg-gray-900 cursor-pointer{% endif %}">
        <p class="text-gray-300">
          Trascina qui un'immagine o <span class="underline">clicca</span> per selezionarla
        </p>
        <input id="fileInput" name="file" type="file" accept="image/*" class="hidden" {% if not has_session_pending %}required{% endif %}/>
      </div>

      <div id="previewWrap" class="{% if not has_session_pending %}hidden{% endif %}">
        <img id="previewImg"
             class="std-img mx-auto rounded-xl border border-gray-800 shadow-md"
             alt="Anteprima"
             {% if has_session_pending %}
             src="{{ url_for('uploaded_file', filename=preload.img) }}"
             {% endif %}/>
      </div>

      <button id="btnSubmit" type="submit"
              class="w-full py-3 rounded-xl bg-emerald-600 hover:bg-emerald-500 text-white font-semibold transition flex items-center justify-center gap-2"
              {% if has_session_pending %}disabled{% endif %}>
        Esegui classificazione
        {% if session.get('pending_prediction_id') %}
          <span id="pendingBadge" class="text-xs px-2 py-0.5 rounded bg-amber-600/70 border border-amber-500 text-amber-50">
            in attesa conferma
          </span>
        {% endif %}
      </button>

      <div id="loading" class="hidden flex items-center gap-2 text-emerald-300">
        <svg class="animate-spin h-5 w-5" viewBox="0 0 24 24" fill="none">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4A4 4 0 004 12z"></path>
        </svg>
        <span>Analisi in corsoâ€¦</span>
      </div>
    </form>
  </div>

  <!-- Card Risultato -->
  <div id="resultBox" class="bg-gray-900/70 border border-gray-800 rounded-2xl p-6 shadow-xl {% if not has_session_pending %}hidden{% endif %}">
    <h3 class="text-lg font-semibold text-emerald-300">Risultato</h3>

    <div class="mt-4 grid grid-cols-1 sm:grid-cols-3 gap-4">
      <div class="bg-gray-800/60 rounded-lg p-4">
        <div class="text-gray-400 text-xs uppercase">Classe</div>
        <div id="predClass" class="text-xl font-semibold mt-1">
          {% if has_session_pending %}{{ preload.cls }}{% endif %}
        </div>
      </div>
      <div class="bg-gray-800/60 rounded-lg p-4">
        <div class="text-gray-400 text-xs uppercase">Confidenza</div>
        <div id="predConf" class="text-xl font-semibold mt-1">
          {% if has_session_pending %}{{ preload.conf }}{% endif %}
        </div>
      </div>
      <div class="bg-gray-800/60 rounded-lg p-4">
        <div class="text-gray-400 text-xs uppercase">Immagine</div>
        <img id="classifiedImg"
             class="std-img mt-2 rounded-md border border-gray-700 mx-auto"
             {% if has_session_pending %}
             src="{{ url_for('uploaded_file', filename=preload.img) }}"
             {% endif %}/>
      </div>
    </div>

    <!-- Linee guida smaltimento -->
    <div id="guides" class="hidden mt-5 bg-gray-800/60 border border-gray-700 rounded-lg p-4">
      <div class="text-gray-400 text-xs uppercase">Smaltimento consigliato</div>
      <div id="guideContent" class="mt-2 text-gray-200 text-sm flex items-start gap-3"></div>
    </div>

    <div class="mt-6">
      <p class="text-gray-300 mb-2">Il risultato Ã¨ corretto?</p>

      <!-- WRAPPER AZIONI: sparisce dopo conferma -->
      <div id="actionsRow" class="flex flex-wrap items-center gap-3">
        <button id="btnOk" class="px-4 py-2 rounded-lg bg-emerald-600 hover:bg-emerald-500 text-white">SÃ¬, corretto</button>
        <button id="btnNo" class="px-4 py-2 rounded-lg bg-rose-600 hover:bg-rose-500 text-white">No, sbagliato</button>

        <!-- Dropdown nascosto finchÃ© non si clicca "No" -->
        <div id="corrWrap" class="hidden items-center gap-2">
          <select id="corrClass"
                  class="bg-gray-900 border border-gray-700 rounded-lg px-3 py-2 text-sm text-gray-200">
            <option value="">Scegli classe correttaâ€¦</option>
            {% for c in class_names %}
              <option value="{{ c }}">{{ c|capitalize }}</option>
            {% endfor %}
          </select>
          <button id="btnSendCorr"
                  class="px-3 py-2 rounded-lg bg-emerald-600 hover:bg-emerald-500 text-white text-sm">
            Invia
          </button>
        </div>
      </div>
    </div>

    <!-- messaggi locali -->
    <div id="localMsg" class="mt-4 hidden rounded-lg px-4 py-3 text-sm border"></div>
  </div>
</div>

{% if preload %}
<script>
  window.PENDING_PRELOAD = {
    id: "{{ preload.id }}",
    cls: "{{ preload.cls }}",
    conf: "{{ preload.conf }}",
    img: "{{ url_for('uploaded_file', filename=preload.img) }}"
  };
</script>
{% endif %}

<script>
  const form = document.getElementById('uploadForm');
  const csrfField = form.querySelector('input[name="csrf_token"]');
  const dropZone = document.getElementById('dropZone');
  const fileInput = document.getElementById('fileInput');
  const previewWrap = document.getElementById('previewWrap');
  const previewImg = document.getElementById('previewImg');
  const btnSubmit = document.getElementById('btnSubmit');
  const pendingBadge = document.getElementById('pendingBadge');
  const loading = document.getElementById('loading');

  const resultBox = document.getElementById('resultBox');
  const predClass = document.getElementById('predClass');
  const predConf  = document.getElementById('predConf');
  const classifiedImg = document.getElementById('classifiedImg');

  const guides = document.getElementById('guides');
  const guideContent = document.getElementById('guideContent');

  const actionsRow = document.getElementById('actionsRow');
  const btnOk = document.getElementById('btnOk');
  const btnNo = document.getElementById('btnNo');
  const corrWrap = document.getElementById('corrWrap');
  const corrClass = document.getElementById('corrClass');
  const btnSendCorr = document.getElementById('btnSendCorr');
  const localMsg = document.getElementById('localMsg');

  let currentPredictionId = null;

  // Se ricaricato con pending in sessione, precompila e blocca upload
  if (window.PENDING_PRELOAD) {
    currentPredictionId = window.PENDING_PRELOAD.id;
    predClass.textContent = window.PENDING_PRELOAD.cls;
    predConf.textContent = window.PENDING_PRELOAD.conf;
    classifiedImg.src = window.PENDING_PRELOAD.img;
    resultBox.classList.remove('hidden');
    showGuideFor(window.PENDING_PRELOAD.cls);
    showLocal('Predizione in sospeso: conferma o correggi per proseguire.', 'info');
  }

  // Dropzone (attiva solo se non c'Ã¨ pending)
  if (!window.PENDING_PRELOAD) {
    dropZone.addEventListener('click', () => fileInput.click());
    dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.classList.add('bg-gray-900'); });
    dropZone.addEventListener('dragleave', () => dropZone.classList.remove('bg-gray-900'));
    dropZone.addEventListener('drop', e => {
      e.preventDefault(); dropZone.classList.remove('bg-gray-900');
      const f = e.dataTransfer.files[0];
      if (f) { fileInput.files = e.dataTransfer.files; showPreview(f); }
    });
    fileInput.addEventListener('change', e => { if (e.target.files[0]) showPreview(e.target.files[0]); });
  }

  function showPreview(file){
    const reader = new FileReader();
    reader.onload = ev => { previewImg.src = ev.target.result; previewWrap.classList.remove('hidden'); };
    reader.readAsDataURL(file);
  }

  // Mappa linee guida smaltimento
  const DISPOSAL_GUIDES = {
    'plastica': { icon:'ðŸŸ¡', label:'Plastica', bin:'Bidone giallo', note:'Rimuovi liquidi e schiaccia le bottiglie.' },
    'carta': { icon:'ðŸ”µ', label:'Carta', bin:'Bidone blu', note:'No carta unta/plastificata. Appiattisci le scatole.' },
    'vetro': { icon:'ðŸŸ¢', label:'Vetro', bin:'Campana verde', note:'No ceramica/porcellana. Sciacqua i contenitori.' },
    'organico': { icon:'ðŸŸ¤', label:'Organico', bin:'Marrone/umido', note:'Usa sacchetti compostabili. No liquidi.' },
    'indifferenziato': { icon:'âš«', label:'Indifferenziato', bin:'Grigio/nero', note:'Solo rifiuti non riciclabili.' }
  };
  function showGuideFor(cls){
    const g = DISPOSAL_GUIDES[cls];
    if (!g) { guides.classList.add('hidden'); return; }
    guideContent.innerHTML = `
      <div class="shrink-0 text-xl">${g.icon}</div>
      <div>
        <div class="font-semibold">${g.label} â†’ <span class="text-emerald-300">${g.bin}</span></div>
        <div class="text-gray-300 text-sm mt-1">${g.note}</div>
      </div>
    `;
    guides.classList.remove('hidden');
  }

  // Predict
  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    if (window.PENDING_PRELOAD) return; // safety
    toggleLoading(true);
    showLocal('', 'info', true);

    try {
      const fd = new FormData(form);
      const res = await fetch('/predict', { method:'POST', body: fd });
      const data = await res.json();
      if (!res.ok) throw new Error(data.error || 'Errore sconosciuto');

      predClass.textContent = data.class;
      predConf.textContent = data.confidence;
      currentPredictionId = data.prediction_id;
      classifiedImg.src = previewImg.src;

      resultBox.classList.remove('hidden');
      showGuideFor(data.class);
      showLocal('Predizione eseguita. Conferma il risultato.', 'success');

      // blocca upload finchÃ© non confermi
      dropZone.classList.add('opacity-50','pointer-events-none');
      fileInput.disabled = true;
      btnSubmit.disabled = true;
      if (pendingBadge) { pendingBadge.style.display = ''; }
    } catch (err) {
      showLocal(err.message, 'error');
    } finally {
      toggleLoading(false);
    }
  });

  // Feedback
  btnOk.addEventListener('click', () => sendFeedback('correct'));
  btnNo.addEventListener('click', () => { corrWrap.classList.remove('hidden'); });

  btnSendCorr.addEventListener('click', () => {
    if (!corrClass.value) { showLocal('Seleziona la classe corretta.', 'error'); return; }
    sendFeedback('incorrect', corrClass.value);
  });

  async function sendFeedback(type, correctClass=null){
    const id = currentPredictionId || (window.PENDING_PRELOAD && window.PENDING_PRELOAD.id);
    if (!id) return;
    try{
      const res = await fetch('/feedback', {
        method:'POST',
        headers:{ 'Content-Type':'application/json', 'X-CSRFToken': csrfField.value },
        body: JSON.stringify({ prediction_id: id, feedback_type: type, correct_class: correctClass })
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.error || 'Errore invio feedback');

      showLocal('Feedback salvato! Grazie ðŸ™Œ', 'success');

      // sblocca upload e nascondi azioni
      actionsRow.classList.add('hidden');
      dropZone.classList.remove('opacity-50','pointer-events-none');
      fileInput.disabled = false;
      btnSubmit.disabled = false;

      if (pendingBadge) { pendingBadge.style.display = 'none'; }
      // reset preload
      window.PENDING_PRELOAD = null;
      currentPredictionId = null;
    }catch(err){
      showLocal(err.message, 'error');
    }
  }

  function toggleLoading(state){
    loading.classList.toggle('hidden', !state);
    btnSubmit.disabled = state;
  }
  function showLocal(msg, type='info', hide=false){
    if (hide) { localMsg.classList.add('hidden'); return; }
    localMsg.textContent = msg;
    localMsg.className = 'mt-4 rounded-lg px-4 py-3 text-sm border ' +
      (type==='success' ? 'bg-emerald-900/70 border-emerald-800 text-emerald-100' :
       type==='error'   ? 'bg-rose-900/70 border-rose-800 text-rose-100' :
                          'bg-sky-900/70 border-sky-800 text-sky-100');
    localMsg.classList.remove('hidden');
  }
</script>
{% endblock %}
